<!DOCTYPE html>
<html>
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    <base target="_top">
    <style>
      body {
        font-family: "Quicksand", sans-serif;
        max-width: 800px;
        margin: 40px auto;
        background-color: #f8f9fa;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        color: #333;
        line-height: 1.6;
      }

      h2 {
        text-align: center;
        color: #004085;
        margin-bottom: 10px;
      }

      .intro {
        background-color: #fff3cd;
        border-left: 6px solid #ffeeba;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
      }

      .intro strong {
        color: #d39e00;
      }

      .highlight {
        color: #c82333;
        font-weight: bold;
      }

      label {
        font-weight: 600;
        margin-top: 12px;
        display: block;
        color: #555;
      }

      input[type="text"],
      input[type="email"],
      textarea {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 15px;
      }

      textarea {
        resize: vertical;
      }

      button {
        padding: 10px 20px;
        margin-top: 15px;
        margin-right: 10px;
        border: none;
        border-radius: 6px;
        background-color: #007bff;
        color: white;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      button:hover {
        background-color: #0056b3;
        transform: translateY(-1px);
      }      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
        transform: none;
      }

      button.executed {
        background-color: #28a745;
        opacity: 0.7;
        cursor: not-allowed;
      }

      button.executed:hover {
        background-color: #28a745;
        transform: none;
      }

      /* Loading spinner */
      .loading {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      button.loading .loading {
        display: inline-block;
      }

      #scoreSection,
      #notFoundForm {
        margin-top: 25px;
        background: #ffffff;
        border: 1px solid #ddd;
        padding: 20px;
        border-radius: 8px;
        display: none;
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }


      #supportBtn {
        background-color: #dc3545;
      }

      #supportBtn:hover {
        background-color: #c82333;
      }

      a {
        color: #0056b3;
        text-decoration: underline;
      }

      .alert {
        padding: 12px 16px;
        margin: 16px 0;
        border-radius: 6px;
        display: none;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .alert-overload {
        background-color: #f1c40f;
        color: #8b4513;
        border: 2px solid #f39c12;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(241, 196, 15, 0.3);
      }

      .retry-button {
        background-color: #17a2b8;
        margin-top: 10px;
        font-size: 14px;
        padding: 8px 16px;
      }

      .retry-button:hover {
        background-color: #138496;
      }      /* Field-specific error messages */
      .field-error {
        color: #dc3545;
        font-size: 14px;
        margin-top: 5px;
        margin-bottom: 10px;
        padding: 8px 12px;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        display: none;
        animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
        from { 
          opacity: 0; 
          transform: translateY(-10px); 
          max-height: 0;
        }
        to { 
          opacity: 1; 
          transform: translateY(0); 
          max-height: 100px;
        }
      }

      .field-error.show {
        display: block;
      }

      input.error, textarea.error {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
      }

      @media (max-width: 600px) {
        body {
          margin: 20px;
          padding: 20px;
        }
        button {
          width: 100%;
          margin-bottom: 10px;
        }
      }
    </style>
  </head>
  <body>
    <h2>TRA C·ª®U ƒêI·ªÇM S·ªê KH√ìA H·ªåC üéì</h2>

    <div class="intro">
      <p><strong>Kh√≥a h·ªçc:</strong> Train The Trainers 2025 - AI For Super Teacher ‚Äì ƒêi·ªán Bi√™n</p>
      <p>STEAM for Vietnam xin ch√∫c m·ª´ng Th·∫ßy/C√¥ ƒë√£ ho√†n th√†nh kh√≥a h·ªçc!<br>
      Vui l√≤ng nh·∫≠p email ƒë·ªÉ tra c·ª©u k·∫øt qu·∫£ ƒëi·ªÉm s·ªë v√† tr·∫°ng th√°i t·ªët nghi·ªáp.</p>
      <p><strong>üìå H∆Ø·ªöNG D·∫™N:</strong></p>
      <ul>
        <li class="highlight">‚ö†Ô∏è ƒê·ªÉ nh·∫≠n ƒë∆∞·ª£c Ch·ª©ng nh·∫≠n ho√†n th√†nh kh√≥a h·ªçc, th·∫ßy c√¥ s·∫Ω c·∫ßn c√≥ t·ªïng ƒëi·ªÉm c·∫£ kh√≥a b·∫±ng ho·∫∑c tr√™n 70 ƒëi·ªÉm.</li>
        <li>Th·∫ßy c√¥ c√≥ th·ªÉ xem c√°ch t√≠nh ƒëi·ªÉm t·∫°i ƒë√¢y: <a href="https://byvn.net/Dvx5" target="_blank">https://byvn.net/Dvx5</a></li>
        <li>N·∫øu kh√¥ng t√¨m th·∫•y email ho·∫∑c c√≥ th·∫Øc m·∫Øc v·ªÅ ƒëi·ªÉm s·ªë, vui l√≤ng s·ª≠ d·ª•ng form y√™u c·∫ßu h·ªó tr·ª£ b√™n d∆∞·ªõi.</li>
      </ul>
    </div>

    <div id="alertContainer"></div>

    <form id="mainForm">      <label>Email:</label>
      <input type="email" id="email" required>
      <div id="emailError" class="field-error"></div>
      <button type="button" onclick="getInfo()" id="searchBtn">
        <span class="loading"></span>
        Tra c·ª©u
      </button>
      <button type="button" onclick="resetForm()" style="background-color: #6c757d; margin-left: 10px;">
        üîÑ L√†m m·ªõi
      </button>

      <div id="scoreSection">
        <div id="scoreDetail" style="margin-top: 16px;">
        </div>
      </div>      <div id="notFoundForm">
      <div style="background: linear-gradient(90deg, #fffbe6 0%, #fff3cd 100%); border: 2px solid #ffeaa7; padding: 24px 12px; border-radius: 12px; margin-bottom: 22px; box-shadow: 0 2px 8px #ffeeba55;">
        <h3 style="color: #856404; margin-top: 0; font-size: 1.25em; letter-spacing: 0.5px;">
        üìã <span style="font-weight: bold;">Th√¥ng b√°o t·ª´ Ban T·ªï ch·ª©c</span>
        </h3>
        <p style="color: #856404; font-size: 1.08em; margin-bottom: 15px;">
        <span style="font-size: 1.15em; color: #c82333; font-weight: bold;">‚ùóBan t·ªï ch·ª©c r·∫•t l·∫•y l√†m ti·∫øc: Th·∫ßy/C√¥ ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán ƒë·ªÉ t·ªët nghi·ªáp kh√≥a h·ªçc.</span><br>
        <span style="font-weight: 600;">Ban t·ªï ch·ª©c xin c·∫£m ∆°n s·ª± tham gia c·ªßa c√°c th·∫ßy c√¥.</span>
        </p>
        <p style="color: #856404; margin-bottom: 0; font-size: 1em;">
        <span style="color: #c82333; font-weight: bold;">Qu√Ω Th·∫ßy/c√¥ vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin email. Tr∆∞·ªùng h·ª£p c√≥ khi·∫øu n·∫°i ƒëi·ªÉm s·ªë, vui l√≤ng b·ªï sung c√°c th√¥ng tin sau ƒë·ªÉ BTC ki·ªÉm tra:</span>
        </p>
        <p style="color: #856404; margin-bottom: 0; font-size: 1em;">
        <span style="color: #c82333; font-weight: bold;">Th·ªùi h·∫°n s·ª≠a th√¥ng tin l√† h·∫øt ng√†y 10 th√°ng 6 (10/6). M·ªçi th·∫Øc m·∫Øc hay y√™u c·∫ßu h·ªó tr·ª£ xin vui l√≤ng li√™n h·ªá qua Mail: trainthetrainers@steamforvietnam.org</span>
        </p>
      </div>
        
        <h4>üìû Y√™u c·∫ßu h·ªó tr·ª£ t·ª´ Ban T·ªï ch·ª©c:</h4>        <label>Email:</label>
        <input type="email" id="nfEmail">
        <div id="nfEmailError" class="field-error"></div>

        <label>H·ªç t√™n (Full Name):</label>
        <input type="text" id="nfName">
        <div id="nfNameError" class="field-error"></div>

        <label>Tr∆∞·ªùng/ƒê∆°n v·ªã (School):</label>
        <input type="text" id="nfSchool">
        <div id="nfSchoolError" class="field-error"></div>

        <div style="color: #c82333; font-size: 0.98em; margin-bottom: 8px; margin-top: 2px;">
          <span style="font-weight: 500;">Vui l√≤ng vi·∫øt t√™n ƒë∆°n v·ªã ƒë√∫ng ƒë·ªãnh d·∫°ng</span>
        </div>

        <label>T·ªïng ƒëi·ªÉm hi·ªán t·∫°i (Total Score):</label>
        <input type="text" id="nfTotalScore" placeholder="V√≠ d·ª•: 75">
        <div id="nfTotalScoreError" class="field-error"></div>

        <button type="button" onclick="submitSupportRequest()" id="supportBtn">
          <span class="loading"></span>
          Y√™u c·∫ßu h·ªó tr·ª£
        </button>
      </div>
    </form>    <script>
      let retryCount = 0;
      const maxRetries = 3;
      // Execution tracking to prevent multiple submissions
      let executionTracker = {
        submitSupportRequest: false
      };

      // Function to show field-specific error
      function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const errorDiv = document.getElementById(fieldId + 'Error');
        
        if (field && errorDiv) {
          field.classList.add('error');
          errorDiv.textContent = message;
          errorDiv.classList.add('show');
          
          // Scroll to the field if needed
          field.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }

      // Function to clear field-specific error
      function clearFieldError(fieldId) {
        const field = document.getElementById(fieldId);
        const errorDiv = document.getElementById(fieldId + 'Error');
        
        if (field && errorDiv) {
          field.classList.remove('error');
          errorDiv.classList.remove('show');
          errorDiv.textContent = '';
        }
      }

      // Function to clear all field errors
      function clearAllFieldErrors() {
        const errorFields = ['email', 'nfEmail', 'nfName', 'nfSchool', 'nfTotalScore'];
        errorFields.forEach(fieldId => clearFieldError(fieldId));
      }

      function showAlert(message, type = 'error', includeRetry = false) {
        const container = document.getElementById('alertContainer');
        const alertDiv = document.createElement('div'); // Changed variable name to avoid conflict
        let alertClass = `alert alert-${type}`;
        if (type === 'overload') {
          alertClass = 'alert alert-overload';
        }
        alertDiv.className = alertClass;
        alertDiv.innerHTML = message;

        if (includeRetry && retryCount < maxRetries) {
          const retryBtn = document.createElement('button');
          retryBtn.className = 'retry-button';
          retryBtn.textContent = `Th·ª≠ l·∫°i (${retryCount + 1}/${maxRetries})`;
          retryBtn.onclick = function() {
            retryCount++;
            // Decide which function to retry. If it's always getInfo, then:
            getInfo();
          };
          alertDiv.appendChild(document.createElement('br'));
          alertDiv.appendChild(retryBtn);
        }

        alertDiv.style.display = 'block';
        container.innerHTML = ''; // Clear previous alerts
        container.appendChild(alertDiv);

        const hideTimeout = (type === 'overload' || type === 'error') ? 8000 : 6000;
        setTimeout(() => {
          if (alertDiv.parentNode) { // Check if still part of DOM
            alertDiv.style.display = 'none';
          }
        }, hideTimeout);
      }      function setButtonLoading(buttonId, loading) {
        const btn = document.getElementById(buttonId);
        if (btn) {
            if (loading) {
            btn.disabled = true;
            btn.classList.add('loading');
            } else {
            btn.disabled = false;
            btn.classList.remove('loading');
            }
        }
      }

      function setButtonExecuted(buttonId, executed) {
        const btn = document.getElementById(buttonId);
        if (btn) {
          if (executed) {
            btn.classList.add('executed');
            btn.disabled = true;
          } else {
            btn.classList.remove('executed');
            btn.disabled = false;
          }
        }
      }

      function hideAllSections() {
        document.getElementById("scoreSection").style.display = "none";
        document.getElementById("notFoundForm").style.display = "none";
        const scoreDetail = document.getElementById('scoreDetail');
        if (scoreDetail) {
          scoreDetail.innerHTML = '';
        }
      }

      function validateEmail(email) {
        // Enhanced email validation
        const re = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
        return re.test(String(email).toLowerCase()) && email.length <= 254;
      }

      function renderScoreDetail(scores, isPass) {
        const container = document.getElementById('scoreDetail');
        if (!container) return;

        if (!scores) {
          container.style.display = 'none';
          container.innerHTML = '';
          return;
        }

        const statusText = isPass ? 'ƒê·∫†T' : 'KH√îNG ƒê·∫†T';
        const statusColor = isPass ? '#155724' : '#c82333';

        const totalScore = typeof scores.total === 'number'
          ? scores.total
          : (scores.total || '');

        container.innerHTML = `
          <div style="border-top: 1px solid #dee2e6; margin-top: 16px; padding-top: 14px;">
            <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: #004085;">
              K·∫æT QU·∫¢ T·ªîNG H·ª¢P
            </h3>
            <div style="
              display: flex;
              flex-wrap: wrap;
              justify-content: space-between;
              align-items: center;
              background: #e9ecef;
              border-radius: 8px;
              padding: 10px 12px;
              margin-bottom: 14px;
            ">
              <div style="font-weight: 600; color: #004085;">
                T·ªïng ƒëi·ªÉm: <span style="font-size: 1.1em;">${totalScore}</span>
              </div>
              <div style="
                font-weight: 700;
                color: ${statusColor};
                padding: 4px 10px;
                border-radius: 999px;
                border: 1px solid ${statusColor};
                text-transform: uppercase;
              ">
                Tr·∫°ng th√°i: ${statusText}
              </div>
            </div>

            <div style="
              overflow-x: auto;
              border-radius: 8px;
              border: 1px solid #dee2e6;
              background: #ffffff;
            ">
              <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                <thead style="background: #f8f9fa;">
                  <tr>
                    <th style="border-bottom: 1px solid #dee2e6; padding: 8px 6px; text-align: left;">M·ª•c</th>
                    <th style="border-bottom: 1px solid #dee2e6; padding: 8px 6px; text-align: center;">ƒêi·ªÉm danh</th>
                    <th style="border-bottom: 1px solid #dee2e6; padding: 8px 6px; text-align: center;">T·ª± lu·∫≠n</th>
                    <th style="border-bottom: 1px solid #dee2e6; padding: 8px 6px; text-align: center;">Ph·∫£n t∆∞</th>
                    <th style="border-bottom: 1px solid #dee2e6; padding: 8px 6px; text-align: center;">T·ªïng</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px;">B√†i 1</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">${scores.bai1?.attend ?? ''}</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">${scores.bai1?.essay ?? ''}</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">${scores.bai1?.reflection ?? ''}</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">${scores.bai1?.total ?? ''}</td>
                  </tr>
                  <tr style="background: #fcfcfd;">
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px;">B√†i 2</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">${scores.bai2?.attend ?? ''}</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">${scores.bai2?.essay ?? ''}</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">${scores.bai2?.reflection ?? ''}</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">${scores.bai2?.total ?? ''}</td>
                  </tr>
                  <tr>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px;">B√†i 3</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">${scores.bai3?.attend ?? ''}</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">${scores.bai3?.essay ?? ''}</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">${scores.bai3?.reflection ?? ''}</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">${scores.bai3?.total ?? ''}</td>
                  </tr>
                  <tr style="background: #fcfcfd;">
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px;">B√†i 4</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">${scores.bai4?.attend ?? ''}</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">‚Äî</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">‚Äî</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">${scores.bai4?.total ?? ''}</td>
                  </tr>
                  <tr>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px;">B√†i t·∫≠p cu·ªëi kh√≥a</td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">
                      ƒê·ªÅ 01: ${scores.final?.de01 ?? ''}
                    </td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">
                      ƒê·ªÅ 02: ${scores.final?.de02 ?? ''}
                    </td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">
                      ƒê·ªÅ 03: ${scores.final?.de03 ?? ''}
                    </td>
                    <td style="border-bottom: 1px solid #f1f3f5; padding: 8px 6px; text-align: center;">
                      T·ªïng: ${scores.final?.total ?? ''}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        `;

        container.style.display = 'block';
      }

      // Show confirmation dialog before submission
      function showConfirmationDialog(title, message, onConfirm) {
        const dialog = document.createElement('div');
        dialog.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          font-family: "Quicksand", sans-serif;
        `;
        
        const dialogContent = document.createElement('div');
        dialogContent.style.cssText = `
          background: white;
          border-radius: 12px;
          max-width: 600px;
          width: 90%;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
          overflow: hidden;
        `;
        
        dialogContent.innerHTML = `
          <div style="
            background: linear-gradient(135deg, #004085 0%, #0056b3 100%);
            color: white;
            padding: 10px 20px;
            text-align: left;
            border-bottom: 2px solid #0056b3;
          ">
            <h3 style="
              margin: 0;
              font-size: 1.25em;
              font-weight: 600;
              letter-spacing: 0.5px;
            ">${title}</h3>
          </div>
          
          <div style="
            padding: 12px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
          ">
            <div style="
              background: white;
              padding: 10px;
              border-radius: 8px;
              border: 1px solid #e9ecef;
              line-height: 1.6;
              color: #333;
            ">${message}</div>
          </div>
          
          <div style="
            padding: 10px 20px;
            background: white;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
          ">
            <button id="confirmDialogNo" style="
              background-color: #6c757d;
              color: white;
              border: none;
              padding: 12px 25px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 16px;
              font-weight: 500;
              transition: background-color 0.3s ease;
            ">H·ªßy</button>
            <button id="confirmDialogYes" style="
              background-color: #28a745;
              color: white;
              border: none;
              padding: 12px 25px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 16px;
              font-weight: 600;
              transition: background-color 0.3s ease;
            ">X√°c nh·∫≠n</button>
          </div>
        `;
        
        dialog.appendChild(dialogContent);
        document.body.appendChild(dialog);
        
        // Add hover effects
        const yesBtn = document.getElementById('confirmDialogYes');
        const noBtn = document.getElementById('confirmDialogNo');
        
        yesBtn.onmouseover = function() { this.style.backgroundColor = '#218838'; };
        yesBtn.onmouseout = function() { this.style.backgroundColor = '#28a745'; };
        noBtn.onmouseover = function() { this.style.backgroundColor = '#545b62'; };
        noBtn.onmouseout = function() { this.style.backgroundColor = '#6c757d'; };
        
        yesBtn.onclick = function() {
          document.body.removeChild(dialog);
          onConfirm();
        };
        
        noBtn.onclick = function() {
          document.body.removeChild(dialog);
        };
        
        // Close on ESC key
        function handleEsc(e) {
          if (e.key === 'Escape') {
            document.body.removeChild(dialog);
            document.removeEventListener('keydown', handleEsc);
          }
        }
        document.addEventListener('keydown', handleEsc);
      }

      function handleServerError(error, buttonIdToReset) {
        console.error('Server Error:', error);
        if (buttonIdToReset) setButtonLoading(buttonIdToReset, false);

        const errorMsgText = (error && error.message) ? error.message : (typeof error === 'string' ? error : 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ m√°y ch·ªß.');
        const errorMsgLowerCase = errorMsgText.toLowerCase();

        const isOverloadError = errorMsgLowerCase.includes('qu√° t·∫£i') ||
                               errorMsgLowerCase.includes('th·ª≠ l·∫°i sau') ||
                               errorMsgLowerCase.includes('quota') ||
                               errorMsgLowerCase.includes('rate limit') ||
                               errorMsgLowerCase.includes('service invoked too many times') ||
                               errorMsgLowerCase.includes('exceeded') ||
                               errorMsgLowerCase.includes('timeout') ||
                               errorMsgLowerCase.includes('argument too large') ||
                               errorMsgLowerCase.includes('ƒë·ªëi s·ªë qu√° l·ªõn');

        if (isOverloadError) {
          showAlert(
            'üö® <strong>H·ªá th·ªëng ƒëang qu√° t·∫£i ho·∫∑c g·∫∑p gi·ªõi h·∫°n.</strong><br>' +
            '‚è±Ô∏è ' + errorMsgText + '<br>' +
            'üìû M·ªçi th·∫Øc m·∫Øc, vui l√≤ng li√™n h·ªá k√™nh sau: Email: trainthetrainers@steamforvietnam.org',
            'overload',
            buttonIdToReset === 'searchBtn' // Only show retry for getInfo initially
          );
        } else {
          showAlert(
            '‚ùå <strong>C√≥ l·ªói x·∫£y ra:</strong><br>' +
            errorMsgText + '<br>' +
            'üìû M·ªçi th·∫Øc m·∫Øc, vui l√≤ng li√™n h·ªá k√™nh sau: Email: trainthetrainers@steamforvietnam.org',
            'error'
          );
        }
      }      function getInfo() {
        const email = document.getElementById('email').value.trim();

        // Clear previous errors
        clearAllFieldErrors();

        if (!email) {
          showFieldError('email', 'Vui l√≤ng nh·∫≠p email');
          return;
        }
        if (!validateEmail(email)) {
          showFieldError('email', 'Email kh√¥ng h·ª£p l·ªá - vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng');
          return;
        }

        hideAllSections();
        setButtonLoading('searchBtn', true);
        document.getElementById('alertContainer').innerHTML = '';

        google.script.run
          .withSuccessHandler(function(result) {
            setButtonLoading('searchBtn', false);

            if (result.error) {
              if (result.isOverload) {
                showAlert(
                  'üö® <strong>H·ªá th·ªëng ƒëang qu√° t·∫£i</strong><br>' +
                  '‚è±Ô∏è ' + result.error,
                  'overload',
                  true // Enable retry button for getInfo
                );
              } else {
                showAlert(result.error, 'error');
              }
              return;
            }

            if (result.found) {
              renderScoreDetail(result.scoreDetails || null, !!result.pass);
              document.getElementById('scoreSection').style.display = 'block';
              showAlert('‚úÖ T√¨m th·∫•y th√¥ng tin! K·∫øt qu·∫£ ƒëi·ªÉm s·ªë ƒë∆∞·ª£c hi·ªÉn th·ªã b√™n d∆∞·ªõi.', 'success');
              retryCount = 0;
            } else {
              document.getElementById('nfEmail').value = email;
              document.getElementById("notFoundForm").style.display = "block";
              showAlert('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y email trong h·ªá th·ªëng ho·∫∑c ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán t·ªët nghi·ªáp.', 'warning');
              retryCount = 0;
            }
          })
          .withFailureHandler(function(error) {
            handleServerError(error, 'searchBtn');
          })
          .getUserInfo(email);
      }      function confirmCorrect() {
        // Check if already executed
        if (executionTracker.confirmCorrect) {
          showAlert('‚ùå <strong>Th√¥ng tin ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n tr∆∞·ªõc ƒë√≥.</strong><br>M·ªói email ch·ªâ ƒë∆∞·ª£c x√°c nh·∫≠n m·ªôt l·∫ßn duy nh·∫•t.', 'warning');
          return;
        }

        // Clear previous errors
        clearAllFieldErrors();

        const email = document.getElementById('email').value.trim();
        if (!email) {
          showFieldError('email', 'Email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng khi x√°c nh·∫≠n');
          return;
        }

        if (!validateEmail(email)) {
          showFieldError('email', 'ƒê·ªãnh d·∫°ng email kh√¥ng h·ª£p l·ªá - vui l√≤ng ki·ªÉm tra l·∫°i');
          return;
        }

        // Collect form data to validate against original data
        const formData = {
          name: document.getElementById('name').value.trim(),
          school: document.getElementById('school').value.trim()
        };

        if (!formData.name) {
          showFieldError('name', 'H·ªç t√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng khi x√°c nh·∫≠n');
          return;
        }        // Show confirmation dialog
        const confirmMessage = `
          <div style="margin-bottom: 15px;">
            <div style="margin-bottom: 10px;"><strong>Email:</strong></div>
            <div style="background: #e9ecef; padding: 8px 12px; border-radius: 4px; margin-bottom: 15px;">${email}</div>
            
            <div style="margin-bottom: 10px;"><strong>H·ªç t√™n:</strong></div>
            <div style="background: #e9ecef; padding: 8px 12px; border-radius: 4px; margin-bottom: 15px;">${formData.name}</div>
            
            <div style="margin-bottom: 10px;"><strong>Tr∆∞·ªùng/ƒê∆°n v·ªã:</strong></div>
            <div style="background: #e9ecef; padding: 8px 12px; border-radius: 4px; margin-bottom: 20px;">${formData.school || 'Kh√¥ng c√≥'}</div>
          </div>
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; border-radius: 6px; text-align: center;">
            <p style="color: #c82333; font-weight: bold; margin: 0;">‚ö†Ô∏è L∆∞u √Ω: Sau khi x√°c nh·∫≠n, th√¥ng tin s·∫Ω kh√¥ng th·ªÉ ch·ªânh s·ª≠a l·∫°i!</p>
          </div>
        `;

        showConfirmationDialog(
          'X√°c nh·∫≠n th√¥ng tin ch√≠nh x√°c',
          confirmMessage,
          function() {
            // Mark as executed before processing
            executionTracker.confirmCorrect = true;
            
            setButtonLoading('confirmBtn', true);
            document.getElementById('alertContainer').innerHTML = '';            google.script.run
              .withSuccessHandler(function(messageFromServer) {
                setButtonLoading('confirmBtn', false);
                setButtonExecuted('confirmBtn', true);
                document.getElementById("mainForm").reset();
                hideAllSections();
                document.getElementById("thankYouMessage").style.display = "block";
                showAlert('‚úÖ ' + messageFromServer, 'success');
                originalUserInfo = null;
              })
              .withFailureHandler(function(error) {
                // Reset execution tracker on failure
                executionTracker.confirmCorrect = false;
                handleServerError(error, 'confirmBtn');
              })
              .confirmCorrect(email, formData);
          }
        );
      }      function submitForm() { // This is for "C·∫ßn ch·ªânh s·ª≠a / C√≥ ghi ch√∫"
        // Check if already executed
        if (executionTracker.submitForm) {
          showAlert('‚ùå <strong>Y√™u c·∫ßu ch·ªânh s·ª≠a ƒë√£ ƒë∆∞·ª£c g·ª≠i tr∆∞·ªõc ƒë√≥.</strong><br>M·ªói email ch·ªâ ƒë∆∞·ª£c g·ª≠i y√™u c·∫ßu m·ªôt l·∫ßn duy nh·∫•t.', 'warning');
          return;
        }

        // Clear previous errors
        clearAllFieldErrors();

        const formData = {
          email: document.getElementById('email').value.trim(),
          name: document.getElementById('name').value.trim(),
          school: document.getElementById('school').value.trim(),
          note: document.getElementById('note').value.trim(),
        };

        let hasError = false;

        if (!formData.email) {
          showFieldError('email', 'Email l√† b·∫Øt bu·ªôc khi g·ª≠i ch·ªânh s·ª≠a');
          hasError = true;
        } else if (!validateEmail(formData.email)) {
          showFieldError('email', 'ƒê·ªãnh d·∫°ng email kh√¥ng h·ª£p l·ªá - vui l√≤ng ki·ªÉm tra l·∫°i');
          hasError = true;
        }

        if (!formData.name) {
          showFieldError('name', 'H·ªç t√™n l√† b·∫Øt bu·ªôc khi g·ª≠i ch·ªânh s·ª≠a');
          hasError = true;
        }

        if (hasError) {
          return;
        }

        if (!originalUserInfo) {
            showAlert('L·ªói: Kh√¥ng c√≥ th√¥ng tin g·ªëc ƒë·ªÉ so s√°nh. Vui l√≤ng tra c·ª©u l·∫°i email tr∆∞·ªõc.', 'error');
            return;
        }        // Show confirmation dialog
        const confirmMessage = `
          <div style="margin-bottom: 15px;">
            <div style="margin-bottom: 10px;"><strong>Email:</strong></div>
            <div style="background: #e9ecef; padding: 8px 12px; border-radius: 4px; margin-bottom: 15px;">${formData.email}</div>
            
            <div style="margin-bottom: 10px;"><strong>H·ªç t√™n:</strong></div>
            <div style="background: #e9ecef; padding: 8px 12px; border-radius: 4px; margin-bottom: 15px;">${formData.name}</div>
            
            <div style="margin-bottom: 10px;"><strong>Tr∆∞·ªùng/ƒê∆°n v·ªã:</strong></div>
            <div style="background: #e9ecef; padding: 8px 12px; border-radius: 4px; margin-bottom: 15px;">${formData.school || 'Kh√¥ng c√≥'}</div>
            
            <div style="margin-bottom: 10px;"><strong>Ghi ch√∫:</strong></div>
            <div style="background: #e9ecef; padding: 8px 12px; border-radius: 4px; margin-bottom: 20px;">${formData.note || 'Kh√¥ng c√≥'}</div>
          </div>
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; border-radius: 6px; text-align: center;">
            <p style="color: #c82333; font-weight: bold; margin: 0;">‚ö†Ô∏è L∆∞u √Ω: Sau khi g·ª≠i, y√™u c·∫ßu s·∫Ω kh√¥ng th·ªÉ ch·ªânh s·ª≠a l·∫°i!</p>
          </div>
        `;

        showConfirmationDialog(
          'X√°c nh·∫≠n thay ƒë·ªïi th√¥ng tin',
          confirmMessage,
          function() {
            // Mark as executed before processing
            executionTracker.submitForm = true;

            setButtonLoading('editBtn', true);
            document.getElementById('alertContainer').innerHTML = '';            google.script.run
              .withSuccessHandler(function(messageFromServer) {
                setButtonLoading('editBtn', false);
                setButtonExecuted('editBtn', true);
                document.getElementById("mainForm").reset();
                hideAllSections();
                document.getElementById("thankYouMessage").style.display = "block";
                showAlert('‚úÖ ' + messageFromServer, 'success');
                originalUserInfo = null;
              })
              .withFailureHandler(function(error) {
                // Reset execution tracker on failure
                executionTracker.submitForm = false;
                handleServerError(error, 'editBtn');
              })
              .submitConfirmation(formData, originalUserInfo);
          }
        );
      }      function submitSupportRequest() {
        // Check if already executed
        if (executionTracker.submitSupportRequest) {
          showAlert('‚ùå <strong>Y√™u c·∫ßu h·ªó tr·ª£ ƒë√£ ƒë∆∞·ª£c g·ª≠i tr∆∞·ªõc ƒë√≥.</strong><br>M·ªói email ch·ªâ ƒë∆∞·ª£c g·ª≠i y√™u c·∫ßu m·ªôt l·∫ßn duy nh·∫•t.', 'warning');
          return;
        }

        // Clear previous errors
        clearAllFieldErrors();

        const data = {
          email: document.getElementById('nfEmail').value.trim(),
          name: document.getElementById('nfName').value.trim(),
          school: document.getElementById('nfSchool').value.trim(),
          total_score: document.getElementById('nfTotalScore').value.trim()
        };

        let hasError = false;

        if (!data.email) {
          showFieldError('nfEmail', 'Email l√† b·∫Øt bu·ªôc cho y√™u c·∫ßu h·ªó tr·ª£');
          hasError = true;
        } else if (!validateEmail(data.email)) {
          showFieldError('nfEmail', 'ƒê·ªãnh d·∫°ng email kh√¥ng h·ª£p l·ªá - vui l√≤ng ki·ªÉm tra l·∫°i');
          hasError = true;
        }

        if (!data.name) {
          showFieldError('nfName', 'H·ªç t√™n l√† b·∫Øt bu·ªôc cho y√™u c·∫ßu h·ªó tr·ª£');
          hasError = true;
        }

        if (!data.school) {
          showFieldError('nfSchool', 'Tr∆∞·ªùng/ƒê∆°n v·ªã l√† b·∫Øt bu·ªôc cho y√™u c·∫ßu h·ªó tr·ª£');
          hasError = true;
        }

        if (!data.total_score) {
          showFieldError('nfTotalScore', 'T·ªïng ƒëi·ªÉm hi·ªán t·∫°i l√† b·∫Øt bu·ªôc cho y√™u c·∫ßu h·ªó tr·ª£');
          hasError = true;
        }

        if (hasError) {
          return;
        }        // Show confirmation dialog
        const confirmMessage = `
          <div style="margin-bottom: 15px;">
            <div style="margin-bottom: 10px;"><strong>Email:</strong></div>
            <div style="background: #e9ecef; padding: 8px 12px; border-radius: 4px; margin-bottom: 15px;">${data.email}</div>
            
            <div style="margin-bottom: 10px;"><strong>H·ªç t√™n:</strong></div>
            <div style="background: #e9ecef; padding: 8px 12px; border-radius: 4px; margin-bottom: 15px;">${data.name}</div>
            
            <div style="margin-bottom: 10px;"><strong>Tr∆∞·ªùng/ƒê∆°n v·ªã:</strong></div>
            <div style="background: #e9ecef; padding: 8px 12px; border-radius: 4px; margin-bottom: 15px;">${data.school}</div>
            
            <div style="margin-bottom: 10px;"><strong>T·ªïng ƒëi·ªÉm hi·ªán t·∫°i:</strong></div>
            <div style="background: #e9ecef; padding: 8px 12px; border-radius: 4px; margin-bottom: 20px;">${data.total_score}</div>
          </div>
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; border-radius: 6px; text-align: center;">
            <p style="color: #c82333; font-weight: bold; margin: 0;">‚ö†Ô∏è L∆∞u √Ω: Sau khi g·ª≠i, y√™u c·∫ßu s·∫Ω kh√¥ng th·ªÉ ch·ªânh s·ª≠a l·∫°i!</p>
          </div>
        `;

        showConfirmationDialog(
          'X√°c nh·∫≠n y√™u c·∫ßu h·ªó tr·ª£',
          confirmMessage,
          function() {
            // Mark as executed before processing
            executionTracker.submitSupportRequest = true;

            setButtonLoading('supportBtn', true);
            document.getElementById('alertContainer').innerHTML = '';            google.script.run
              .withSuccessHandler(function(messageFromServer) {
                setButtonLoading('supportBtn', false);
                setButtonExecuted('supportBtn', true);
                document.getElementById("notFoundForm").style.display = 'none'; // Hide after submission
                document.getElementById('nfEmail').value = ''; // Clear fields
                document.getElementById('nfName').value = '';
                document.getElementById('nfSchool').value = '';
                document.getElementById('nfTotalScore').value = '';
                showAlert('‚úÖ ' + messageFromServer + ' BTC s·∫Ω ki·ªÉm tra v√† ph·∫£n h·ªìi s·ªõm. Xin c·∫£m ∆°n!', 'success');
              })
              .withFailureHandler(function(error) {
                // Reset execution tracker on failure
                executionTracker.submitSupportRequest = false;
                handleServerError(error, 'supportBtn');
              })
              .submitSupportRequest(data);
          }
        );
      }

      function submitNotFound() {
        const data = {
          email: document.getElementById('nfEmail').value.trim(),
          name: document.getElementById('nfName').value.trim(),
          school: document.getElementById('nfSchool').value.trim(),
        };

        if (!data.email || !data.name) {
          showAlert('Email v√† h·ªç t√™n l√† b·∫Øt bu·ªôc cho y√™u c·∫ßu n√†y.', 'warning');
          return;
        }
        if (!validateEmail(data.email)) {
          showAlert('Email kh√¥ng h·ª£p l·ªá.', 'warning');
          return;
        }
        // Optional: Validate school if it's mandatory for not found requests
        // if (!data.school) {
        //   showAlert('Tr∆∞·ªùng/ƒê∆°n v·ªã l√† b·∫Øt bu·ªôc cho y√™u c·∫ßu n√†y.', 'warning');
        //   return;
        // }

        setButtonLoading('notFoundBtn', true);
        document.getElementById('alertContainer').innerHTML = '';

        google.script.run
          .withSuccessHandler(function(messageFromServer) {
            setButtonLoading('notFoundBtn', false);
            document.getElementById("notFoundForm").style.display = 'none'; // Hide after submission
            document.getElementById('nfEmail').value = ''; // Clear fields
            document.getElementById('nfName').value = '';
            document.getElementById('nfSchool').value = '';
            showAlert('‚úÖ ' + messageFromServer + ' BTC s·∫Ω ki·ªÉm tra v√† ph·∫£n h·ªìi s·ªõm. Xin c·∫£m ∆°n!', 'success');
          })
          .withFailureHandler(function(error) {
            handleServerError(error, 'notFoundBtn');
          })
          .submitNotFoundRequest(data);
      }      function resetForm() {
        document.getElementById("mainForm").reset();
        hideAllSections();
        document.getElementById('alertContainer').innerHTML = '';
        // Clear all field errors
        clearAllFieldErrors();
        retryCount = 0;
        originalUserInfo = null;
        // Reset execution tracker
        executionTracker = {
          confirmCorrect: false,
          submitForm: false,
          submitSupportRequest: false
        };
        // Reset button states
        setButtonExecuted('confirmBtn', false);
        setButtonExecuted('editBtn', false);
        setButtonExecuted('supportBtn', false);
        // Clear support request form fields
        document.getElementById('nfEmail').value = '';
        document.getElementById('nfName').value = '';
        document.getElementById('nfSchool').value = '';
        document.getElementById('nfTotalScore').value = '';
        const scoreDetail = document.getElementById('scoreDetail');
        if (scoreDetail) {
          scoreDetail.style.display = 'none';
          scoreDetail.innerHTML = '';
        }
        document.getElementById('email').focus();
      }      window.onload = function() {
        document.getElementById('email').focus();
        
        // Add event listeners to clear field errors when user types
        const fieldsWithErrors = ['email', 'name', 'school', 'nfEmail', 'nfName', 'nfSchool', 'nfTotalScore'];
        fieldsWithErrors.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field) {
            field.addEventListener('input', function() {
              clearFieldError(fieldId);
            });
            field.addEventListener('focus', function() {
              clearFieldError(fieldId);
            });
          }
        });
      };

      document.getElementById('email').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          getInfo();
        }
      });
    </script>
  </body>
</html>