<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Paper Weather Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&display=swap');
        :root {
            --yellow: #ffc800;
            --black: #000000;
            --gray: #f7f7f7;
            --border: #e6e6e6;
            --card: #ffffff;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Poppins', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--gray);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            color: #000;
        }
        .container {
            width: 800px;
            height: 480px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 14px 32px rgba(0,0,0,0.16);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        header.header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--black);
            color: #fff;
            padding: 8px 16px;
            height: 54px;
            gap: 16px;
            flex-wrap: wrap;
        }
        .logo {
            font-weight: 800;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 16px;
        }
        .logo span { color: var(--yellow); }
        .header-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 14px;
            flex-wrap: wrap;
        }
        main.main {
            flex: 1;
            display: grid;
            grid-template-columns: 1.25fr 0.9fr;
            gap: 12px;
            padding: 12px 16px;
            min-height: 0;
        }
        .card {
            background: var(--card);
            border: 2px solid #000;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 18px rgba(0,0,0,0.05);
        }
        .weather {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }
        .hero {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 14px;
            align-items: center;
        }
        .hero-icon {
            width: 108px;
            height: 108px;
            border-radius: 22px;
            background: var(--yellow);
            display: grid;
            place-items: center;
            border: 5px solid #000;
        }
        .hero-icon svg { width: 80px; height: 80px; }
        .hero-text .condition { font-size: 16px; font-weight: 800; letter-spacing: 0.5px; }
        .hero-text .temperature { font-size: 60px; font-weight: 800; line-height: 1; }

        .weather-action { text-align: center; }
        .weather-action .card-label { font-size: 15px; font-weight: 800; letter-spacing: 0.5px; }
        .weather-action .card-title { font-size: 25px; font-weight: 800; margin-top: 2px; line-height: 1.3; }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .stat-card {
            background: #000;
            border-radius: 12px;
            padding: 8px 10px;
            color: #fff;
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: center;
        }
        .stat-card svg { width: 30px; height: 30px; }
        .stat-label { color: var(--yellow); font-size: 13px; font-weight: 700; }
        .stat-value { font-size: 20px; font-weight: 800; }

        .aqi { display: flex; flex-direction: column; gap: 12px; min-height: 0; }
        .aqi-gauge { display: grid; place-items: center; padding: 12px; }
        .aqi-gauge svg { width: 200px; height: 200px; }
        .aqi-action { display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: center; }
        .aqi-icon { width: 64px; height: 64px; display: grid; place-items: center; }
        .aqi-icon svg { width: 64px; height: 64px; }
        .aqi-action-text { font-size: 22px; font-weight: 800; line-height: 1.2; }

        footer.footer {
            background: #f7f7f7;
            border-top: 1px solid var(--border);
            padding: 6px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #555;
            min-height: 36px;
            gap: 12px;
            flex-wrap: wrap;
        }
        .quote { max-width: 65%; line-height: 1.2; }
        .font-strong { font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .font-body { font-weight: 700; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo"><span>Weather & AQI</span></div>
            <div class="header-meta">
                <span id="current-date">NOV 24, 2025</span>
                <span>|</span>
                <span id="header-location">HANOI, VN</span>
            </div>
        </header>

        <main class="main">
            <section class="weather">
                <div class="hero card">
                    <div id="weather-hero-icon" class="hero-icon"></div>
                    <div class="hero-text">
                        <div id="condition-main" class="condition">RAIN/STORM</div>
                        <div id="temp-main" class="temperature">24째C</div>
                    </div>
                </div>

                <div class="weather-action card">
                    <div id="weather-action-condition" class="card-label">RAIN/STORM</div>
                    <div id="weather-action-text" class="card-title">BRING UMBRELLA</div>
                </div>

                <div class="stats-row">
                    <div class="stat-card">
                        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2S5 11 5 15a7 7 0 0 0 14 0C19 11 12 2 12 2Z" fill="var(--yellow)" stroke="#000" stroke-width="1"/></svg>
                        <div class="stat-text">
                            <div class="stat-label">Humidity</div>
                            <div id="humidity" class="stat-value">92%</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M14 5a2 2 0 1 0-4 0v7.5a4 4 0 1 0 4 0Z" stroke="var(--yellow)" stroke-width="2" fill="none"/>
                            <circle cx="12" cy="16" r="2.5" fill="var(--yellow)"/>
                            <line x1="12" y1="5" x2="12" y2="10" stroke="var(--yellow)" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <div class="stat-text">
                            <div class="stat-label">Feels Like</div>
                            <div id="feels-like" class="stat-value">28째C</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M4 9h11a3 3 0 1 0-3-3" stroke="var(--yellow)" stroke-width="2" fill="none" stroke-linecap="round"/>
                            <path d="M4 15h13a2 2 0 1 1-2 2" stroke="var(--yellow)" stroke-width="2" fill="none" stroke-linecap="round"/>
                        </svg>
                        <div class="stat-text">
                            <div class="stat-label">Wind</div>
                            <div id="wind-speed" class="stat-value">12 km/h</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="aqi">
                <div class="aqi-gauge card">
                    <svg viewBox="-120 -120 240 240" aria-labelledby="aqi-title">
                        <title id="aqi-title">Air Quality Gauge</title>
                        <circle cx="0" cy="0" r="94" stroke="#000" stroke-width="26" fill="none"/>
                        <circle id="aqi-arc-active" cx="0" cy="0" r="94" stroke="var(--yellow)" stroke-width="26" fill="none" stroke-linecap="round" stroke-dasharray="254 590" transform="rotate(-90)"/>
                        <circle cx="0" cy="0" r="78" fill="#000"/>
                        <text x="0" y="-14" text-anchor="middle" fill="#fff" font-size="18" font-weight="700">AQI</text>
                        <text id="aqi-label" x="0" y="34" text-anchor="middle" fill="var(--yellow)" font-size="58" font-weight="800">155</text>
                        <text id="aqi-status" x="0" y="68" text-anchor="middle" fill="#fff" font-size="22" font-weight="800">UNHEALTHY</text>
                    </svg>
                </div>
                <div class="aqi-action card">
                    <div id="aqi-action-icon" class="aqi-icon"></div>
                    <div id="aqi-action-text" class="aqi-action-text">WEAR MASK</div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <div id="quote-text" class="quote">"I don't wish for an easy life, I wish to have strength to conquer challenges"</div>
            <div id="last-updated" class="updated">Update at: 14:30</div>
        </footer>
    </div>

    <script>
        const CONFIG = {
            lat: 21.0285,
            lon: 105.8542,
            locationLabel: 'HANOI, VN',
            quote: "I don't wish for an easy life, I wish to have strength to conquer challenges",
        };

        const FALLBACK_WEATHER = {
            weather: [{ id: 201, description: 'Rain/Storm' }],
            main: { temp: 24, feels_like: 28, humidity: 92 },
            wind: { speed: 3.3 },
        };

        const FALLBACK_AQI = {
            list: [{ components: { pm2_5: 155 } }],
        };

        const FALLBACK_LAST_UPDATED = '14:30';

        const WEATHER_ACTIONS = [
            { tempMax: 5, humidityMin: 0, weatherCodes: [511, 600, 601, 602, 611, 612, 613, 615, 616, 620, 621, 622], action: "Stay warm, have warm tea. Extreme cold.", condition: "Severe Winter Weather", iconKey: "cold" },
            { tempMax: 5, humidityMin: 0, weatherCodes: [800, 801, 802, 803, 804], action: "Stay warm, have warm tea.", condition: "Freezing Cold", iconKey: "cold" },
            { tempMax: 10, humidityMin: 0, weatherCodes: null, action: "Warm tea recommended. Stay cozy.", condition: "Cold", iconKey: "tea" },
            { tempMax: 15, humidityMin: 70, weatherCodes: null, action: "Wear warm layers. Stay dry.", condition: "Chilly & Damp", iconKey: "warm" },
            { tempMin: 35, humidityMin: 50, weatherCodes: null, action: "Wear sunglasses, stay hydrated.", condition: "Very Hot", iconKey: "sunglasses" },
            { tempMin: 30, humidityMin: 75, weatherCodes: null, action: "Wear sunglasses, drink water often.", condition: "Extreme Humidity/Muggy", iconKey: "sunglasses" },
            { tempMin: 30, humidityMin: 50, weatherCodes: null, action: "Wear sunglasses, drink water.", condition: "Very Hot & Humid", iconKey: "sunglasses" },
            { tempMin: 30, humidityMax: 40, weatherCodes: null, action: "Wear sunglasses, hydrate constantly.", condition: "Hot & Dry", iconKey: "sunglasses" },
            { tempMin: -Infinity, tempMax: Infinity, weatherCodes: [200, 201, 202, 210, 211, 212, 221, 230, 231, 232], action: "Bring umbrella. Severe T-Storm.", condition: "Thunderstorm", iconKey: "umbrella" },
            { tempMin: -Infinity, tempMax: Infinity, weatherCodes: [502, 503, 504, 522], action: "Bring umbrella. Heavy rain.", condition: "Heavy Rain", iconKey: "umbrella" },
            { tempMin: -Infinity, tempMax: Infinity, weatherCodes: [300, 301, 302, 310, 311, 312, 313, 314, 321, 500, 501, 520, 521, 531], action: "Bring umbrella.", condition: "Rain/Drizzle", iconKey: "umbrella" },
            { tempMin: -Infinity, tempMax: Infinity, weatherCodes: [701, 711, 721, 741], action: "Low visibility, wear mask if smoky.", condition: "Mist/Fog/Haze", iconKey: "haze" },
            { tempMin: 25, tempMax: 35, humidityMax: 40, weatherCodes: [800, 801], action: "Wear sunglasses. Great day!", condition: "Sunny", iconKey: "sunglasses" },
            { tempMin: 15, tempMax: 30, humidityMax: 40, weatherCodes: null, action: "Enjoy outdoors, stay hydrated.", condition: "Pleasant & Dry", iconKey: "sunny" },
            { tempMin: 15, tempMax: 30, humidityMin: 70, weatherCodes: null, action: "Comfortable day. Light walk.", condition: "Warm & Humid", iconKey: "sunny" },
            { tempMin: 15, tempMax: 30, humidityMin: 41, humidityMax: 69, weatherCodes: null, action: "Perfect weather! Enjoy!", condition: "Ideal Comfort", iconKey: "sunny" },
            { tempMin: -Infinity, tempMax: Infinity, weatherCodes: [800, 801, 802, 803, 804], action: "Standard day. Check UV index.", condition: "Clear/Cloudy Sky", iconKey: "sunny" },
            { tempMin: -Infinity, tempMax: Infinity, weatherCodes: null, action: "Enjoy the day.", condition: "Comfortable Day", iconKey: "sunny" },
        ];

        const AQI_ACTIONS = [
            { max: 12, status: 'GOOD', action: 'Enjoy the fresh air', iconKey: 'smile', color: '#00E400' },
            { max: 35.4, status: 'MODERATE', action: 'Limit long outdoor exposure', iconKey: 'breeze', color: '#FFFF00' },
            { max: 55.4, status: 'UNHEALTHY (SG)', action: 'Mask up if sensitive', iconKey: 'mask', color: '#FF7E00' },
            { max: 150.4, status: 'UNHEALTHY', action: 'Wear mask outdoors', iconKey: 'mask', color: '#FF0000' },
            { max: 250.4, status: 'VERY UNHEALTHY', action: 'Stay indoors when possible', iconKey: 'home', color: '#8F3F97' },
            { max: Infinity, status: 'HAZARDOUS', action: 'Avoid outdoor activity', iconKey: 'mask', color: '#7E0023' },
        ];

        function getAqiActionForWeather(aqiAction, temp) {
            if (temp >= 30 && aqiAction.max <= 100) {
                return { ...aqiAction, action: 'Drink water', iconKey: 'water' };
            }
            return aqiAction;
        }

        const WEATHER_ACTION_ICONS = {
            umbrella: `<svg viewBox="0 0 120 120"><path d="M12 72c0-34 29-62 64-62s64 28 64 62H12Z" fill="#000" stroke="#000" stroke-width="6" stroke-linejoin="round"/><path d="M76 72v44" stroke="#ffc800" stroke-width="10" stroke-linecap="round"/><path d="M76 114c0 10-10 20-22 20" stroke="#000" stroke-width="9" stroke-linecap="round" fill="none"/><circle cx="76" cy="72" r="7" fill="#000"/><path d="M50 16c0 8-6 14-14 14s-14-6-14-14C22 6 36-6 36-6s14 12 14 22Z" fill="#000"/><path d="M110 26c0 6-5 11-11 11s-11-5-11-11c0-8 11-18 11-18s11 10 11 18Z" fill="#000"/></svg>`,
            cold: `<svg viewBox="0 0 108 108"><path d="M92.75 68.35c6.96-6.8 11.25-16.3 11.25-26.82C104 20.8 87.2 4 66.5 4c-17.83 0-32.75 12.47-36.54 29.19h-3.04C14.33 33.19 4 43.49 4 56.13c0 7.3 3.42 13.8 8.75 18.02" stroke="#000" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" fill="none"/><path d="M54 61.5v17.73M61.08 54.42L54 61.5l-7.08-7.08M38.67 70.35L54 79.23M36.08 60.67l2.59 9.68-9.67 2.58M38.67 88.07L54 79.23M29 85.48l9.67 2.59-2.59 9.67M54 96.91V79.23M46.92 104L54 96.91l7.08 7.09M69.33 88.07L54 79.23M71.92 97.74l-2.59-9.67 9.67-2.59M69.33 70.35L54 79.23M79 72.93l-9.67-2.58 2.59-9.68" stroke="#000" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>`,
            heat: `<svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="30" fill="#ffc800" stroke="#000" stroke-width="6"/><g stroke="#000" stroke-width="6" stroke-linecap="round"><line x1="60" y1="12" x2="60" y2="0"/><line x1="60" y1="120" x2="60" y2="108"/><line x1="12" y1="60" x2="0" y2="60"/><line x1="120" y1="60" x2="108" y2="60"/><line x1="20" y1="20" x2="8" y2="8"/><line x1="100" y1="20" x2="112" y2="8"/><line x1="20" y1="100" x2="8" y2="112"/><line x1="100" y1="100" x2="112" y2="112"/></g></svg>`,
            haze: `<svg viewBox="0 0 120 120"><rect x="18" y="30" width="84" height="14" rx="7" fill="#000"/><rect x="10" y="52" width="84" height="14" rx="7" fill="#ffc800"/><rect x="26" y="74" width="80" height="14" rx="7" fill="#000"/><circle cx="86" cy="36" r="8" fill="#ffc800"/></svg>`,
            sunny: `<svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="30" fill="#ffc800" stroke="#000" stroke-width="6"/><g stroke="#000" stroke-width="6" stroke-linecap="round"><line x1="60" y1="14" x2="60" y2="0"/><line x1="60" y1="120" x2="60" y2="106"/><line x1="14" y1="60" x2="0" y2="60"/><line x1="120" y1="60" x2="106" y2="60"/><line x1="20" y1="20" x2="8" y2="8"/><line x1="100" y1="20" x2="112" y2="8"/><line x1="20" y1="100" x2="8" y2="112"/><line x1="100" y1="100" x2="112" y2="112"/></g></svg>`,
            sunglasses: `<svg viewBox="0 0 120 120"><ellipse cx="35" cy="60" rx="25" ry="20" fill="#000" stroke="#000" stroke-width="4"/><ellipse cx="85" cy="60" rx="25" ry="20" fill="#000" stroke="#000" stroke-width="4"/><path d="M60 60c0-8 5-12 10-12" stroke="#000" stroke-width="4" fill="none"/><path d="M60 60c0-8-5-12-10-12" stroke="#000" stroke-width="4" fill="none"/><line x1="10" y1="55" x2="0" y2="50" stroke="#000" stroke-width="4"/><line x1="110" y1="55" x2="120" y2="50" stroke="#000" stroke-width="4"/><ellipse cx="35" cy="60" rx="18" ry="14" fill="#ffc800" opacity="0.3"/><ellipse cx="85" cy="60" rx="18" ry="14" fill="#ffc800" opacity="0.3"/></svg>`,
            tea: `<svg viewBox="0 0 120 120"><path d="M20 50h60v45c0 11-13 20-30 20s-30-9-30-20V50z" fill="#ffc800" stroke="#000" stroke-width="5"/><path d="M80 55h15c8 0 15 7 15 15s-7 15-15 15H80" stroke="#000" stroke-width="5" fill="none"/><path d="M35 35c0-8 5-15 15-15s15 7 15 15" stroke="#000" stroke-width="4" fill="none" opacity="0.6"/><path d="M45 30c0-6 4-12 12-12" stroke="#000" stroke-width="4" fill="none" opacity="0.6"/><ellipse cx="50" cy="50" rx="30" ry="8" fill="#000" opacity="0.2"/></svg>`,
            warm: `<svg viewBox="0 0 120 120"><path d="M60 20v15M45 25l5 12M75 25l-5 12" stroke="#ffc800" stroke-width="4" stroke-linecap="round"/><path d="M35 45h50l8 55H27l8-55z" fill="#ffc800" stroke="#000" stroke-width="5"/><path d="M35 45c0-15 11-25 25-25s25 10 25 25" stroke="#000" stroke-width="5" fill="none"/><rect x="45" y="60" width="30" height="25" rx="3" fill="#000"/><circle cx="60" cy="72" r="6" fill="#ffc800"/></svg>`,
        };

        const AQI_ACTION_ICONS = {
            mask: `<svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="44" fill="#ffc800" stroke="#000" stroke-width="6"/><path d="M44 48c2 6 8 6 10 0" stroke="#000" stroke-width="6" stroke-linecap="round"/><path d="M70 48c2 6 8 6 10 0" stroke="#000" stroke-width="6" stroke-linecap="round"/><rect x="32" y="56" width="56" height="26" rx="8" fill="#fff" stroke="#000" stroke-width="6"/><path d="M32 66c-6 0-12-4-12-10" stroke="#000" stroke-width="6" stroke-linecap="round" fill="none"/><path d="M88 66c6 0 12-4 12-10" stroke="#000" stroke-width="6" stroke-linecap="round" fill="none"/><rect x="42" y="62" width="36" height="10" rx="4" fill="#000"/><path d="M42 72c8 6 20 6 28 0" stroke="#000" stroke-width="6" fill="none" stroke-linecap="round"/></svg>`,
            home: `<svg viewBox="0 0 110 110"><path d="M15 60 55 25 95 60v30H15Z" fill="#000"/><rect x="40" y="62" width="30" height="28" rx="4" fill="#ffc800"/><rect x="53" y="68" width="10" height="22" fill="#000"/></svg>`,
            breeze: `<svg viewBox="0 0 110 110"><path d="M20 46h52a10 10 0 1 0-10-10" stroke="#000" stroke-width="8" fill="none" stroke-linecap="round"/><path d="M20 70h58a10 10 0 1 1-10 10" stroke="#ffc800" stroke-width="8" fill="none" stroke-linecap="round"/></svg>`,
            smile: `<svg viewBox="0 0 110 110"><circle cx="55" cy="55" r="40" fill="#ffc800" stroke="#000" stroke-width="6"/><circle cx="40" cy="45" r="6" fill="#000"/><circle cx="70" cy="45" r="6" fill="#000"/><path d="M38 68c10 10 24 10 34 0" stroke="#000" stroke-width="6" fill="none" stroke-linecap="round"/></svg>`,
            water: `<svg viewBox="0 0 110 110"><path d="M55 10c0 0-35 40-35 60c0 20 15 35 35 35s35-15 35-35c0-20-35-60-35-60z" fill="#ffc800" stroke="#000" stroke-width="6"/><path d="M40 70c5-5 15-5 20 0" stroke="#000" stroke-width="4" stroke-linecap="round" fill="none"/><ellipse cx="55" cy="85" rx="20" ry="8" fill="#000" opacity="0.2"/></svg>`,
        };

        function setIcon(targetId, svgMarkup) {
            const container = document.getElementById(targetId);
            if (container) container.innerHTML = svgMarkup;
        }

        function updateCurrentDate() {
            const now = new Date();
            const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            const month = months[now.getMonth()];
            const day = now.getDate();
            const year = now.getFullYear();
            document.getElementById('current-date').textContent = `${month} ${day}, ${year}`;
            document.getElementById('header-location').textContent = CONFIG.locationLabel;
            document.getElementById('quote-text').textContent = `"${CONFIG.quote}"`;
        }

        async function loadEnvApiKey() {
            try {
                const module = await import('./env-config.js');
                const key = module.OPENWEATHER_API_KEY ?? module.default ?? '';
                return key;
            } catch (error) {
                return '';
            }
        }

        const CACHE_DURATION = 30 * 60 * 1000; // 30 minutes
        const WEATHER_CACHE_KEY = 'weather_cache';
        const AQI_CACHE_KEY = 'aqi_cache';

        function getCachedData(key) {
            try {
                const cached = localStorage.getItem(key);
                if (!cached) return null;
                const { data, timestamp } = JSON.parse(cached);
                if (Date.now() - timestamp < CACHE_DURATION) {
                    return data;
                }
                localStorage.removeItem(key);
                return null;
            } catch (error) {
                console.error('Error reading cache:', error);
                return null;
            }
        }

        function setCachedData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() }));
            } catch (error) {
                console.error('Error setting cache:', error);
            }
        }

        async function fetchWeatherData(key) {
            const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${CONFIG.lat}&lon=${CONFIG.lon}&appid=${key}&units=metric`);
            const data = await response.json();
            setCachedData(WEATHER_CACHE_KEY, data);
            return data;
        }

        async function fetchAQIData(key) {
            const response = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${CONFIG.lat}&lon=${CONFIG.lon}&appid=${key}`);
            const data = await response.json();
            setCachedData(AQI_CACHE_KEY, data);
            return data;
        }

        function pickWeatherAction(temp, humidity, weatherId) {
            return WEATHER_ACTIONS.find(rule => {
                if (typeof rule.tempMin === 'number' && temp < rule.tempMin) return false;
                if (typeof rule.tempMax === 'number' && temp > rule.tempMax) return false;
                if (typeof rule.humidityMin === 'number' && humidity < rule.humidityMin) return false;
                if (typeof rule.humidityMax === 'number' && humidity > rule.humidityMax) return false;
                if (Array.isArray(rule.weatherCodes) && !rule.weatherCodes.includes(weatherId)) return false;
                return true;
            }) ?? WEATHER_ACTIONS[WEATHER_ACTIONS.length - 1];
        }

        function pickAQIAction(pm25) {
            return AQI_ACTIONS.find(rule => pm25 <= rule.max) ?? AQI_ACTIONS[AQI_ACTIONS.length - 1];
        }

        function updateAQIGauge(pm25, aqiInfo) {
            const maxPM25 = 360;
            const normalizedValue = Math.min(pm25 / maxPM25, 1);
            const radius = 94;
            const circumference = 2 * Math.PI * radius;
            const arcLength = circumference * normalizedValue;

            document.getElementById('aqi-arc-active').setAttribute('stroke-dasharray', `${arcLength} ${circumference}`);
            document.getElementById('aqi-arc-active').setAttribute('stroke', aqiInfo.color ?? '#ffc800');
            document.getElementById('aqi-label').textContent = Math.round(pm25);
            document.getElementById('aqi-status').textContent = aqiInfo.status;
        }

        function formatTime(now) {
            const hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${String(hours).padStart(2, '0')}:${minutes}`;
        }

        function kmhFromMs(speedMs) {
            return Math.round(speedMs * 3.6);
        }

        function renderDashboard(weatherData, aqiData, { useCurrentTime = true } = {}) {
            const description = (weatherData.weather?.[0]?.description ?? 'Rain/Storm').toUpperCase();
            const temp = Math.round(weatherData.main?.temp ?? FALLBACK_WEATHER.main.temp);
            const feelsLike = Math.round(weatherData.main?.feels_like ?? FALLBACK_WEATHER.main.feels_like);
            const humidity = weatherData.main?.humidity ?? FALLBACK_WEATHER.main.humidity;
            const windSpeed = kmhFromMs(weatherData.wind?.speed ?? FALLBACK_WEATHER.wind.speed);
            const weatherId = weatherData.weather?.[0]?.id ?? FALLBACK_WEATHER.weather[0].id;

            document.getElementById('condition-main').textContent = description;
            document.getElementById('temp-main').textContent = `${temp}째C`;
            document.getElementById('feels-like').textContent = `${feelsLike}째C`;
            document.getElementById('humidity').textContent = `${humidity}%`;
            document.getElementById('wind-speed').textContent = `${windSpeed} km/h`;

            const weatherAction = pickWeatherAction(temp, humidity, weatherId);
            document.getElementById('weather-action-condition').textContent = weatherAction.condition.toUpperCase();
            document.getElementById('weather-action-text').textContent = weatherAction.action.toUpperCase();
            setIcon('weather-hero-icon', WEATHER_ACTION_ICONS[weatherAction.iconKey] ?? WEATHER_ACTION_ICONS.sunny);

            const pm25 = Math.round(aqiData.list?.[0]?.components?.pm2_5 ?? FALLBACK_AQI.list[0].components.pm2_5);
            const baseAqiAction = pickAQIAction(pm25);
            const aqiAction = getAqiActionForWeather(baseAqiAction, temp);

            updateAQIGauge(pm25, baseAqiAction);
            document.getElementById('aqi-action-text').textContent = aqiAction.action.toUpperCase();
            setIcon('aqi-action-icon', AQI_ACTION_ICONS[aqiAction.iconKey] ?? AQI_ACTION_ICONS.mask);

            const now = new Date();
            const updateTime = useCurrentTime ? formatTime(now) : FALLBACK_LAST_UPDATED;
            document.getElementById('last-updated').textContent = `Update at: ${updateTime}`;
        }

        async function updateWeather() {
            const key = await loadEnvApiKey();
            let weatherData = null;
            let aqiData = null;

            if (key) {
                try {
                    weatherData = getCachedData(WEATHER_CACHE_KEY);
                    if (!weatherData) weatherData = await fetchWeatherData(key);
                } catch (error) {
                    console.error('Weather fetch failed, using fallback', error);
                }

                try {
                    aqiData = getCachedData(AQI_CACHE_KEY);
                    if (!aqiData) aqiData = await fetchAQIData(key);
                } catch (error) {
                    console.error('AQI fetch failed, using fallback', error);
                }
            }

            if (!weatherData) weatherData = FALLBACK_WEATHER;
            if (!aqiData) aqiData = FALLBACK_AQI;

            const isFallback = weatherData === FALLBACK_WEATHER || aqiData === FALLBACK_AQI;
            renderDashboard(weatherData, aqiData, { useCurrentTime: !isFallback });
        }

        setIcon('weather-hero-icon', WEATHER_ACTION_ICONS.umbrella);
        setIcon('aqi-action-icon', AQI_ACTION_ICONS.mask);

        updateCurrentDate();
        updateWeather();
    </script>
</body>
</html>
